# 通用生图插件 (Image Generation)

![:name](https://count.getloli.com/@astrbot_plugin_image_generation?name=astrbot_plugin_image_generation&theme=miku&padding=7&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

### 支持多种主流生图接口的通用图像生成插件，支持文生图、图生图、LLM 自动调用及强大的预设系统。

***

### 命令
- `/生图 <提示词或预设名称> [额外提示词]`
  - 生成图片。示例: `/生图 一只可爱的小猫`
  - 使用预设。示例: `/生图 动漫风`
  - 使用预设并附加额外提示词。示例: `/生图 动漫风 蓝色头发`
  - **图生图模式**：如果消息中包含图片、引用包含图片的消息，或 @ 用户，将自动作为参考图进入图生图模式（需适配器支持）。
  - @ 用户时会获取其头像作为参考图。示例: `/生图 像素风 @用户A`

- `/生图模型`
  - 显示可用模型列表和当前使用的模型。
  - `/生图模型 <序号>` - 切换到指定序号的模型。

- `/预设`
  - 显示所有预设列表。
  - `/预设 添加 <预设名:预设内容>` - 添加新预设。
  - `/预设 删除 <预设名>` - 删除指定预设。

### 功能特性

- ✅ **多适配器支持**：集成 Gemini (原生/OpenAI/Zai)、OpenAI (DALL-E)、Gitee AI 等多种生图接口。
- ✅ **文生图**：根据文字描述生成图片。
- ✅ **图生图**：基于参考图片（支持多张）生成新图片，支持自动识别消息图片、引用图片及 @ 用户头像。
- ✅ **LLM 集成**：支持作为工具被 LLM 自动调用，实现对话式生图。
- ✅ **模型动态切换**：通过指令实时查看和切换生图模型。
- ✅ **高级预设系统**：支持预定义提示词模板，预设内容支持 JSON 格式以配置特定比例和分辨率。
- ✅ **多 API Key 轮询**：支持配置多个 API Key，自动轮询与错误重试，提高稳定性。
- ✅ **系统提供商集成**：支持直接使用 AstrBot 系统中配置的“提供商”，简化配置。
- ✅ **完善的控制**：支持并发任务限制、用户频率限制（Rate Limit）及图片大小限制。

### 适配器支持状态

| 适配器类型       | 文生图 | 图生图 | 分辨率 | 宽高比 | 说明                          |
| :--------------- | :----: | :----: | :----: | :----: | :---------------------------- |
| `gemini`         |   ✅    |   ✅    |   ✅    |   ✅    | Gemini 原生 API               |
| `gemini(OpenAI)` |   ✅    |   ✅    |   ❌    |   ❌    | OpenAI 兼容格式的 Gemini 接口 |
| `gemini(Zai)`    |   ✅    |   ✅    |   ✅    |   ✅    | Zai 风格的 Gemini 接口        |
| `openai`         |   ✅    |   ❌    |   ❌    |   ✅    | OpenAI DALL-E 3               |
| `z-image(gitee)` |   ✅    |   ❌    |   ✅    |   ✅    | Gitee AI (z-image-turbo)      |


### 配置项

#### 基础配置
| 配置项            | 类型    | 默认值 | 说明                                    |
| :---------------- | :------ | :----- | :-------------------------------------- |
| `enable_llm_tool` | boolean | `true` | 是否允许 LLM 在对话中自动调用生图功能。 |

#### 适配器配置 (`adapter`)
| 配置项             | 类型   | 默认值   | 说明                                                                                      |
| :----------------- | :----- | :------- | :---------------------------------------------------------------------------------------- |
| `type`             | string | `gemini` | 适配器类型，可选：`gemini`, `gemini(OpenAI)`, `gemini(Zai)`, `openai`, `z-image(gitee)`。 |
| `provider_id`      | string | `""`     | 使用的系统提供商 ID（推荐）。                                                             |
| `base_url`         | string | `""`     | API 基础 URL（不使用系统提供商时填写）。                                                  |
| `api_keys`         | list   | `[]`     | API Key 列表，支持多个 Key 自动轮询。                                                     |
| `model`            | string | `""`     | 当前使用的生图模型名称。                                                                  |
| `available_models` | list   | `[]`     | 可选模型列表，用于 `/生图模型` 切换。                                                     |
| `proxy`            | string | `""`     | 代理地址，如 `http://127.0.0.1:7890`。                                                    |

#### 生成行为配置 (`generation`)
| 配置项                 | 类型   | 默认值  | 说明                                 |
| :--------------------- | :----- | :------ | :----------------------------------- |
| `timeout`              | number | `180`   | 请求超时时间（秒）。                 |
| `max_retry_attempts`   | number | `3`     | 最大重试次数。                       |
| `rate_limit_seconds`   | number | `0`     | 用户请求频率限制（秒），0 为不限制。 |
| `max_concurrent_tasks` | number | `3`     | 最大并发生图任务数。                 |
| `max_image_size_mb`    | number | `10`    | 允许的参考图最大大小 (MB)。          |
| `default_aspect_ratio` | string | `"1:1"` | 默认图片宽高比。                     |
| `default_resolution`   | string | `"1K"`  | 默认分辨率。                         |

### 使用示例

#### 基础生图
```
/生图 一只在森林里野餐的兔子
```

#### 使用预设
```
/预设 添加 赛博朋克:cyberpunk style, neon lights, futuristic city
/生图 赛博朋克 猫
```

#### 图生图（引用或 @）
1. 发送或引用一张图片。
2. 输入 `/生图 变成动漫风格`。
或者：
`/生图 变成像素风 @用户A` (将使用用户A的头像作为参考图)

#### 切换模型
```
/生图模型        # 查看列表
/生图模型 2      # 切换到第二个模型
```

#### 高级预设 (JSON)
可以在 `/预设 添加` 时使用 JSON 格式：
```json
{
  "prompt": "masterpiece, best quality, 1girl",
  "aspect_ratio": "9:16",
  "resolution": "2K"
}
```
例如 `/预设 添加 表情包:{"prompt": "为我生成图中角色的绘制 Q 版的,LINE 风格的半身像表情包,注意头饰要正确彩色手绘风格,使用 4x6 布局,涵盖各种各样的常用聊天语句,或是一些有关的娱乐 meme其他需求:不要原图复制。所有标注为手写简体中文。", "aspect_ratio": "16:9", "resolution": "2K", "description": "生成 LINE 风格表情包"}`
